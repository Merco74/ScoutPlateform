<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inscription Scouts Cluses</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/css/styles.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
</head>
<body>
  <button class="help-button" data-bs-toggle="modal" data-bs-target="#helpModal">
    <i class="bi bi-headset"></i>
  </button>

  <div class="container">
    <div class="hero">
      <h1>Inscription Scouts & Guides de Cluses</h1>
    </div>

    <form id="inscriptionForm" enctype="multipart/form-data">
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-step active" data-step="1">Qui ?</div>
          <div class="progress-line"></div>
          <div class="progress-step" data-step="2">Santé</div>
          <div class="progress-line"></div>
          <div class="progress-step" data-step="3">Finaliser</div>
        </div>
        <div class="text-center"><span id="progressText" class="fw-bold fs-5">Étape 1 sur 3</span></div>
      </div>

      <!-- ÉTAPE 1 -->
      <div class="step-card active" data-step="1">
        <h2><span class="step-number">1</span> Qui s'inscrit ?</h2>
        <div class="row g-4">
          <div class="col-md-6"><div class="form-floating-custom"><input type="text" class="form-control" id="nom" name="nom" required><label>Nom</label></div></div>
          <div class="col-md-6"><div class="form-floating-custom"><input type="text" class="form-control" id="prenom" name="prenom" required><label>Prénom</label></div></div>
          <div class="col-md-6"><div class="form-floating-custom"><input type="date" class="form-control" id="dateNaissance" name="dateNaissance" required><label>Date de naissance</label></div></div>
          <div class="col-md-6"><div class="form-floating-custom"><input type="number" class="form-control" id="age" name="age" min="6" max="18" required><label>Âge</label></div></div>
          <div class="col-md-6"><div class="form-floating-custom"><select class="form-select" id="sexe" name="sexe" required><option value="">Choisir</option><option value="Masculin">Masculin</option><option value="Féminin">Féminin</option></select><label>Sexe</label></div></div>
          <div class="col-md-6"><div class="form-floating-custom"><select class="form-select" id="categorie" name="categorie" required><option value="">Choisir</option><option value="scout">Scouts (11-17)</option><option value="guide">Guides (11-17)</option><option value="louveteau">Louveteaux (8-11)</option></select><label>Groupe</label></div></div>
          <div class="col-12"><div class="form-floating-custom"><input type="tel" class="form-control" id="telPortable" name="telPortable" required><label>Téléphone parent (06...)</label></div></div>
        </div>
      </div>

      <!-- ÉTAPE 2 -->
      <div class="step-card" data-step="2">
        <h2><span class="step-number">2</span> Santé & Autorisations</h2>
        <div class="alert alert-warning-custom">Document confidentiel - RGPD respecté</div>

        <div class="row g-4">
          <div class="col-md-4"><div class="form-check form-switch p-3 bg-light rounded-3"><input class="form-check-input" type="checkbox" id="allergiesAlimentaires" name="allergiesAlimentaires"><label class="form-check-label ms-3 fs-5">Allergies alimentaires</label></div></div>
          <div class="col-md-4"><div class="form-check form-switch p-3 bg-light rounded-3"><input class="form-check-input" type="checkbox" id="allergiesMedicament" name="allergiesMedicament"><label class="form-check-label ms-3 fs-5">Allergies médicaments</label></div></div>
          <div class="col-md-4"><div class="form-check form-switch p-3 bg-light rounded-3"><input class="form-check-input" type="checkbox" id="problemeSante" name="problemeSante"><label class="form-check-label ms-3 fs-5">Problème de santé</label></div></div>
        </div>

        <div class="mt-4"><div class="form-floating-custom"><textarea class="form-control" id="allergiesDetails" name="allergiesDetails" rows="2"></textarea><label>Détails (facultatif)</label></div></div>

        <div class="row g-4 mt-4">
          <div class="col-md-6"><label class="form-label fw-bold">Carnet de vaccins</label><input type="file" class="form-control" name="vaccinScan" accept="application/pdf,image/*"></div>
          <div class="col-md-6"><label class="form-label fw-bold">Ordonnances</label><input type="file" class="form-control" name="medicationScan" accept="application/pdf,image/*" multiple></div>
        </div>

        <div class="mt-4 p-4 bg-light rounded-3">
          <h5>Autorisations légales (conformes eIDAS)</h5>
          <p class="small">J'accorde aux Scouts et Guides de Cluses l'autorisation d'effectuer des prises de vue photographiques ou enregistrements audiovisuels sur lesquels mon enfant pourrait apparaître. J'autorise leur diffusion (interne, Internet, presse locale). Ces autorisations sont consenties à titre gracieux, pour un territoire illimité et sans limitation de durée, dans le respect du droit à l'image, de la vie privée et du RGPD.</p>
          <p class="small">Je consens à ce que mon enfant effectue des trajets dans des véhicules conduits par un encadrant. Sans cette autorisation, seul le transport par véhicule de secours sera possible.</p>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="droitImage" name="droitImage" checked required><label>OK photos</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="autorisationTransport" name="autorisationTransport" checked required><label>OK transport</label></div>
        </div>

        <div class="signature-container mt-4">
          <label class="form-label fw-bold">Signature parent (valable pour tout)</label>
          <canvas id="signaturePad" class="signature-pad"></canvas>
          <div class="mt-3 d-flex gap-3 justify-content-center">
            <button type="button" class="btn btn-secondary-custom" id="clearSignature">Effacer</button>
            <button type="button" class="btn btn-primary-custom" id="saveSignature">Signature OK</button>
          </div>
          <input type="hidden" id="signature" name="signatureDroitImage" required>
          <input type="hidden" name="signatureSanitaire" id="signatureSanitaire">
          <input type="hidden" name="luEtApprouveDroitImageText" value="Lu et approuvé">
          <input type="hidden" name="luEtApprouveInscriptionText" value="Lu et approuvé">
        </div>
      </div>

      <!-- ÉTAPE 3 -->
      <div class="step-card" data-step="3">
        <h2><span class="step-number">3</span> Finaliser</h2>
        <div id="summary" class="alert alert-success-custom"><div id="summaryContent"></div></div>

        <div class="row g-4 mt-4">
          <div class="col-md-6"><div class="form-floating-custom"><input type="text" class="form-control" id="parentAdresse" name="parentAdresse" required><label>Adresse parent</label></div></div>
          <div class="col-md-6"><div class="form-floating-custom"><input type="email" class="form-control" id="parentEmail" name="parentEmail" required><label>Email</label></div></div>
        </div>

        <div class="form-check mt-4 fs-5">
          <input class="form-check-input" type="checkbox" id="acceptRGPD" required checked>
          <label>J'accepte la <a href="/mentions-legales" target="_blank">politique de confidentialité</a></label>
        </div>

        <div class="alert alert-info mt-4">
          Cotisation : 20€/an<br>
          Virement : FR76 1680 7000 3085 8868 0119 504<br>
          Confirmez par SMS à Mathéo : 06.72.44.49.92
        </div>
      </div>

      <div class="btn-group-navigation">
        <button type="button" class="btn btn-secondary-custom" id="prevBtn" style="display: none;">Précédent</button>
        <button type="button" class="btn btn-primary-custom" id="nextBtn">Suivant</button>
        <button type="submit" class="btn btn-success btn-lg d-none" id="submitBtn">Inscription terminée !</button>
      </div>
    </form>
  </div>

  <div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header bg-primary text-white"><h5>Aide immédiate</h5></div>
      <div class="modal-body text-center p-4">
        <p class="fs-4 fw-bold"><a href="tel:+33672444992">06 72 44 49 92</a></p>
        <p>A privilégié par message lors de problème sinon passer par le forum.</p>
      </div>
    </div></div>
  </div>

  <footer>
    <p>Scouts et Guides de Cluses © 2025 • RGPD • eIDAS • CNIL</p>
    <p><a href="/mentions-legales">Mentions légales</a></p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    class InscriptionAssistant {
      constructor() { this.currentStep = 1; this.totalSteps = 3; this.signaturePad = null; this.init(); }
      init() {
        this.steps = document.querySelectorAll('.step-card');
        this.nextBtn = document.getElementById('nextBtn');
        this.prevBtn = document.getElementById('prevBtn');
        this.submitBtn = document.getElementById('submitBtn');
        this.progressText = document.getElementById('progressText');
        this.signaturePad = new SignaturePad(document.getElementById('signaturePad'));

        this.nextBtn.addEventListener('click', () => this.nextStep());
        this.prevBtn.addEventListener('click', () => this.prevStep());
        document.getElementById('clearSignature').addEventListener('click', () => this.signaturePad.clear());
        document.getElementById('saveSignature').addEventListener('click', () => {
          if (!this.signaturePad.isEmpty()) {
            document.getElementById('signature').value = this.signaturePad.toDataURL();
            document.getElementById('signatureSanitaire').value = this.signaturePad.toDataURL();
          }
        });
        document.getElementById('inscriptionForm').addEventListener('submit', (e) => this.handleSubmit(e));
        this.updateProgress();
      }
      nextStep() { if (this.validateCurrentStep()) { this.currentStep++; this.updateProgress(); } }
      prevStep() { this.currentStep--; this.updateProgress(); }
      validateCurrentStep() {
        let valid = true;
        this.steps[this.currentStep - 1].querySelectorAll('[required]').forEach(f => {
          if (!f.value.trim()) { f.classList.add('is-invalid'); valid = false; } else { f.classList.remove('is-invalid'); }
        });
        if (this.currentStep >= 2 && this.signaturePad.isEmpty()) { valid = false; }
        return valid;
      }
      updateProgress() {
        this.steps.forEach((s, i) => s.style.display = i + 1 === this.currentStep ? 'block' : 'none');
        document.querySelectorAll('.progress-step').forEach((s, i) => {
          s.classList.toggle('active', i + 1 === this.currentStep);
          s.classList.toggle('completed', i + 1 < this.currentStep);
        });
        document.querySelectorAll('.progress-line').forEach((l, i) => l.classList.toggle('completed', i + 1 < this.currentStep));
        this.progressText.textContent = `Étape ${this.currentStep} sur ${this.totalSteps}`;
        this.prevBtn.style.display = this.currentStep > 1 ? 'inline-block' : 'none';
        this.nextBtn.style.display = this.currentStep < this.totalSteps ? 'inline-block' : 'none';
        if (this.currentStep === 3) { this.generateSummary(); this.nextBtn.style.display = 'none'; this.submitBtn.classList.remove('d-none'); }
      }
      generateSummary() {
        const nom = document.getElementById('nom').value;
        const prenom = document.getElementById('prenom').value;
        const categorie = document.getElementById('categorie').selectedOptions[0].text;
        document.getElementById('summaryContent').innerHTML = `<strong>${prenom} ${nom}</strong> • ${categorie}`;
      }
      async handleSubmit(e) {
        e.preventDefault();
        if (!this.validateCurrentStep()) return;
        const formData = new FormData(e.target);
        if (this.signaturePad.isEmpty()) return;
        formData.set('signatureDroitImage', this.signaturePad.toDataURL());
        formData.set('signatureSanitaire', this.signaturePad.toDataURL());
        const btn = document.getElementById('submitBtn');
        btn.disabled = true; btn.innerHTML = 'Envoi...';
        const res = await fetch('/inscription', { method: 'POST', body: formData });
        const data = await res.json();
        if (res.ok) {
          document.body.innerHTML = `<div class="container text-center mt-5"><h1>Inscription réussie !</h1><p>${data.message}</p><p><a href="${data.pdfUrl}" target="_blank">Autorisation</a> • <a href="${data.sanitaryPdfUrl}" target="_blank">Fiche santé</a></p></div>`;
        } else {
          alert(data.message);
        }
        btn.disabled = false; btn.innerHTML = 'Inscription terminée !';
      }
    }
    document.addEventListener('DOMContentLoaded', () => new InscriptionAssistant());
  </script>
</body>

</html>
